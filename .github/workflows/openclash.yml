name: æ„å»º OpenClash è¿è¡Œæ–‡ä»¶

# å¿…é¡»æ·»åŠ æƒé™å£°æ˜ï¼Œå¦åˆ™æ— æ³•åˆ›å»º Release
permissions:
  contents: write

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: å‡†å¤‡å·¥ä½œç›®å½•
        run: |
          mkdir -p workspace/openclash-x86
          mkdir -p workspace/openclash-a53
          mkdir -p output
          echo "âœ… å·¥ä½œç›®å½•åˆ›å»ºå®Œæˆ"

      - name: æ‹‰å– OpenClash è½¯ä»¶åŒ…åˆ†æ”¯
        uses: actions/checkout@v4
        with:
          repository: vernesong/OpenClash
          path: OpenClash
          ref: package
          fetch-depth: 1

      - name: å¤åˆ¶æœ€æ–°çš„ OpenClash IPK å®‰è£…åŒ…
        run: |
          if [ ! -f OpenClash/master/*.ipk ]; then
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ° IPK æ–‡ä»¶"
            exit 1
          fi
          cp -v OpenClash/master/*.ipk workspace/openclash-x86/
          cp -v OpenClash/master/*.ipk workspace/openclash-a53/
          echo "âœ… IPK æ–‡ä»¶å¤åˆ¶å®Œæˆ"

      - name: æå–ç‰ˆæœ¬ä¿¡æ¯
        id: extract_version
        run: |
          if [ ! -f OpenClash/master/version ]; then
            echo "âŒ é”™è¯¯: ç‰ˆæœ¬æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          ver=$(head -n 1 OpenClash/master/version | tr -d '[:space:]')
          if [ -z "$ver" ]; then
            echo "âŒ é”™è¯¯: æ— æ³•æå–ç‰ˆæœ¬å·"
            exit 1
          fi
          echo "version=$ver" >> $GITHUB_ENV
          echo "âœ… æ£€æµ‹åˆ°ç‰ˆæœ¬: $ver"

      - name: æ‹‰å– OpenClash å†…æ ¸åˆ†æ”¯
        uses: actions/checkout@v4
        with:
          repository: vernesong/OpenClash
          path: Meta
          ref: core
          fetch-depth: 1

      - name: è§£å‹å†…æ ¸æ–‡ä»¶
        run: |
          # æ£€æŸ¥å‹ç¼©åŒ…æ˜¯å¦å­˜åœ¨
          if [ ! -f Meta/master/meta/clash-linux-amd64-v1.tar.gz ]; then
            echo "âŒ é”™è¯¯: x86 å†…æ ¸æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          if [ ! -f Meta/master/meta/clash-linux-arm64.tar.gz ]; then
            echo "âŒ é”™è¯¯: ARM64 å†…æ ¸æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
          # è§£å‹ x86_64 å†…æ ¸
          echo "ğŸ“¦ è§£å‹ x86_64 å†…æ ¸..."
          tar -xzf Meta/master/meta/clash-linux-amd64-v1.tar.gz -C workspace/openclash-x86
          mv workspace/openclash-x86/clash workspace/openclash-x86/clash_meta
          
          # è§£å‹ ARM64 å†…æ ¸
          echo "ğŸ“¦ è§£å‹ ARM64 å†…æ ¸..."
          tar -xzf Meta/master/meta/clash-linux-arm64.tar.gz -C workspace/openclash-a53
          mv workspace/openclash-a53/clash workspace/openclash-a53/clash_meta
          
          # éªŒè¯æ–‡ä»¶
          if [ ! -f workspace/openclash-x86/clash_meta ]; then
            echo "âŒ é”™è¯¯: x86 å†…æ ¸è§£å‹å¤±è´¥"
            exit 1
          fi
          if [ ! -f workspace/openclash-a53/clash_meta ]; then
            echo "âŒ é”™è¯¯: ARM64 å†…æ ¸è§£å‹å¤±è´¥"
            exit 1
          fi
          
          echo "âœ… å†…æ ¸æ–‡ä»¶è§£å‹å®Œæˆ"
          echo "=== æ–‡ä»¶æ£€æŸ¥ ==="
          ls -lh workspace/openclash-x86/
          ls -lh workspace/openclash-a53/

      - name: åˆ›å»ºå®‰è£…è„šæœ¬
        run: |
          cat << 'EOF' > workspace/openclash-x86/install.sh
          #!/bin/sh
          
          echo "================================"
          echo "  OpenClash è‡ªåŠ¨å®‰è£…è„šæœ¬"
          echo "================================"
          
          # æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨
          echo "ğŸ“¦ æ­£åœ¨æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨..."
          opkg update
          if [ $? -ne 0 ]; then
              echo "âŒ é”™è¯¯: è½¯ä»¶åŒ…åˆ—è¡¨æ›´æ–°å¤±è´¥"
              exit 1
          fi
          
          # å®‰è£… IPK åŒ…
          echo "ğŸ“¦ æ­£åœ¨å®‰è£… OpenClash..."
          opkg install *.ipk
          if [ $? -ne 0 ]; then
              echo "âŒ é”™è¯¯: OpenClash å®‰è£…å¤±è´¥"
              exit 1
          fi
          
          # åˆ›å»ºå†…æ ¸ç›®å½•
          echo "ğŸ“ æ­£åœ¨é…ç½®å†…æ ¸æ–‡ä»¶..."
          if [ ! -d "/etc/openclash/core/" ]; then
              mkdir -p /etc/openclash/core/
          fi
          
          # ç§»åŠ¨å†…æ ¸æ–‡ä»¶
          if [ ! -f "clash_meta" ]; then
              echo "âŒ é”™è¯¯: å†…æ ¸æ–‡ä»¶ä¸å­˜åœ¨"
              exit 1
          fi
          
          mv clash_meta /etc/openclash/core/
          chmod +x /etc/openclash/core/clash_meta
          
          echo "â³ ç­‰å¾…ç³»ç»Ÿç¨³å®š..."
          sleep 10
          
          # æ£€æŸ¥ç½‘ç»œæ¥å£
          echo "ğŸ” æ£€æŸ¥ç½‘ç»œæ¥å£..."
          ifconfig br-lan > /dev/null 2>&1
          if [ $? -ne 0 ]; then
              echo "âš ï¸  è­¦å‘Š: ç½‘ç»œæ¥å£å¼‚å¸¸,æ­£åœ¨é‡å¯ç½‘ç»œæœåŠ¡..."
              /etc/init.d/network restart
              sleep 5
              echo "âœ… ç½‘ç»œæœåŠ¡é‡å¯å®Œæˆ"
          fi
          
          echo "================================"
          echo "  âœ… OpenClash å®‰è£…æˆåŠŸ!"
          echo "================================"
          exit 0
          EOF
          
          # è®¾ç½®æ‰§è¡Œæƒé™
          chmod +x workspace/openclash-x86/install.sh
          
          # å¤åˆ¶åˆ° ARM64 ç›®å½•
          cp workspace/openclash-x86/install.sh workspace/openclash-a53/install.sh
          chmod +x workspace/openclash-a53/install.sh
          
          echo "âœ… å®‰è£…è„šæœ¬åˆ›å»ºå®Œæˆ"

      - name: å®‰è£… Makeself æ‰“åŒ…å·¥å…·
        run: | 
          echo "ğŸ“¥ æ­£åœ¨ä¸‹è½½ Makeself å·¥å…·..."
          git clone --depth 1 https://github.com/megastep/makeself.git makeself-tool
          chmod +x makeself-tool/makeself.sh
          echo "âœ… Makeself å·¥å…·å®‰è£…å®Œæˆ"

      - name: æ„å»ºè‡ªè§£å‹è¿è¡Œæ–‡ä»¶
        run: |
          echo "ğŸ”¨ å¼€å§‹æ„å»ºè¿è¡Œæ–‡ä»¶..."
          
          # æ„å»º x86_64 ç‰ˆæœ¬
          echo "ğŸ“¦ æ„å»º x86_64 ç‰ˆæœ¬..."
          ./makeself-tool/makeself.sh \
            workspace/openclash-x86/ \
            output/openclash-x86-64-${{ env.version }}.run \
            "OpenClash x86_64 è‡ªåŠ¨å®‰è£…åŒ… - ç”± GitHub Actions è‡ªåŠ¨æ„å»º" \
            ./install.sh
          
          # æ„å»º ARM64 ç‰ˆæœ¬
          echo "ğŸ“¦ æ„å»º ARM64 ç‰ˆæœ¬..."
          ./makeself-tool/makeself.sh \
            workspace/openclash-a53/ \
            output/openclash-aarch64_cortex-a53-${{ env.version }}.run \
            "OpenClash ARM64 è‡ªåŠ¨å®‰è£…åŒ… - ç”± GitHub Actions è‡ªåŠ¨æ„å»º" \
            ./install.sh
          
          # éªŒè¯æ„å»ºç»“æœ
          if [ ! -f output/openclash-x86-64-${{ env.version }}.run ] || \
             [ ! -f output/openclash-aarch64_cortex-a53-${{ env.version }}.run ]; then
            echo "âŒ é”™è¯¯: æ„å»ºæ–‡ä»¶ç”Ÿæˆå¤±è´¥"
            exit 1
          fi
          
          echo "âœ… è¿è¡Œæ–‡ä»¶æ„å»ºå®Œæˆ"
          echo "=== æ„å»ºäº§ç‰© ==="
          ls -lh output/
          
          # è®¡ç®—æ–‡ä»¶å“ˆå¸Œå€¼
          echo "=== æ–‡ä»¶æ ¡éªŒå’Œ ==="
          cd output
          sha256sum *.run | tee sha256sums.txt
          cd ..

      - name: å‘å¸ƒç‰ˆæœ¬å¹¶ä¸Šä¼ æ–‡ä»¶
        uses: softprops/action-gh-release@v2
        if: env.version != ''
        with:
          tag_name: ${{ env.version }}
          name: "OpenClash v${{ env.version }}"
          files: |
            output/*.run
            output/sha256sums.txt
          body: |
            ## ğŸ“¦ OpenClash v${{ env.version }} è‡ªåŠ¨æ„å»ºç‰ˆæœ¬
            
            ![GitHub](https://img.shields.io/badge/OpenClash.run-è‡ªåŠ¨æ„å»º-blue?logo=github&logoColor=fff&labelColor=red&style=for-the-badge)
            [![å›½å†…åŠ é€Ÿä¸‹è½½](https://img.shields.io/badge/å›½å†…åŠ é€Ÿç«™ä¸‹è½½-FC7C0D?logo=github&logoColor=fff&labelColor=000&style=for-the-badge)](https://wkdaily.cpolar.cn/archives/1)
            ![ä¸‹è½½ç»Ÿè®¡](https://img.shields.io/github/downloads/wukongdaily/RunFilesBuilder/${{ env.version }}/total?style=for-the-badge&labelColor=black&color=%2325c2a0)
            
            ### ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯
            - **ç‰ˆæœ¬å·**: ${{ env.version }}
            - **æ„å»ºæ—¶é—´**: ${{ github.event.repository.updated_at }}
            - **æ„å»ºæ–¹å¼**: GitHub Actions è‡ªåŠ¨åŒ–æ„å»º
            
            ### ğŸ“¥ ä¸‹è½½è¯´æ˜
            
            | æ¶æ„ | æ–‡ä»¶å | é€‚ç”¨è®¾å¤‡ |
            |------|--------|----------|
            | x86_64 | `openclash-x86-64-${{ env.version }}.run` | x86_64 è½¯è·¯ç”±ã€è™šæ‹Ÿæœº |
            | ARM64 | `openclash-aarch64_cortex-a53-${{ env.version }}.run` | ARM64 è®¾å¤‡ (å¦‚æ ‘è“æ´¾ã€NanoPi ç­‰) |
            
            ### ğŸš€ å®‰è£…æ–¹æ³•
            
            1. ä¸Šä¼  `.run` æ–‡ä»¶åˆ°è·¯ç”±å™¨
            2. æ·»åŠ æ‰§è¡Œæƒé™: `chmod +x openclash-*.run`
            3. è¿è¡Œå®‰è£…: `./openclash-*.run`
            
            ### ğŸ” æ–‡ä»¶æ ¡éªŒ
            
            è¯·ä¸‹è½½ `sha256sums.txt` æ–‡ä»¶éªŒè¯å®Œæ•´æ€§ã€‚
            
            ### âš ï¸ æ³¨æ„äº‹é¡¹
            
            - å®‰è£…å‰è¯·å¤‡ä»½é‡è¦é…ç½®
            - ç¡®ä¿ç½‘ç»œè¿æ¥æ­£å¸¸
            - å®‰è£…è¿‡ç¨‹ä¸­å¯èƒ½ä¼šé‡å¯ç½‘ç»œæœåŠ¡
            
            ---
            
            *ç”± GitHub Actions è‡ªåŠ¨æ„å»ºå’Œå‘å¸ƒ*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: æ„å»ºå®Œæˆé€šçŸ¥
        if: success()
        run: |
          echo "================================"
          echo "  ğŸ‰ æ„å»ºæµç¨‹å…¨éƒ¨å®Œæˆ!"
          echo "================================"
          echo "ç‰ˆæœ¬: ${{ env.version }}"
          echo "æ„å»ºæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "Release åœ°å€: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ env.version }}"
          echo "================================"
